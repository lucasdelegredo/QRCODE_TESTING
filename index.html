<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitor de QRCode (JSON)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5e9" />
  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    /* Suporte a overscroll em iOS para evitar bounce dentro do app */
    body { overscroll-behavior: contain; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-3xl mx-auto p-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-500 flex items-center justify-center text-white font-bold">QR</div>
      <div>
        <h1 class="text-xl font-semibold leading-tight">Leitor de QRCode • JSON</h1>
        <p class="text-xs text-slate-500 -mt-0.5">Aponte a câmera para um QRCode que contenha um JSON.</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="themeToggle" class="text-xs px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Tema</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-4 space-y-4">
    <!-- Controle da câmera -->
    <section class="p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <div class="flex flex-col sm:flex-row sm:items-end gap-3">
        <div class="flex-1">
          <label for="cameraSelect" class="text-sm text-slate-600">Câmera</label>
          <select id="cameraSelect" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnStart" class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-50">Iniciar</button>
          <button id="btnStop" class="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 disabled:opacity-50" disabled>Parar</button>
          <button id="btnFlip" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100" title="Alternar câmera">↺</button>
        </div>
      </div>
      <div id="reader" class="mt-4 rounded-2xl overflow-hidden border border-slate-200"></div>
      <p id="hint" class="mt-2 text-xs text-slate-500">Dica: use a câmera traseira para melhor foco. A leitura é automática.</p>
    </section>

    <!-- Resultado visual -->
    <section id="resultSection" class="hidden p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <div class="flex items-start gap-3">
        <div class="flex-1">
          <h2 class="text-lg font-semibold">Informações lidas</h2>
          <p class="text-sm text-slate-500">Dados extraídos do QRCode e organizados.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnRescan" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Ler novamente</button>
          <button id="btnCopy" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Copiar JSON</button>
          <button id="btnDownload" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Baixar JSON</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3" id="cards"></div>

      <details class="mt-4 open:bg-slate-50 rounded-xl">
        <summary class="cursor-pointer px-3 py-2 rounded-xl border border-slate-200">JSON bruto</summary>
        <pre id="raw" class="mt-2 p-3 text-xs rounded-xl bg-slate-900 text-slate-100 overflow-auto"></pre>
      </details>
    </section>

    <!-- Entrada manual -->
    <section class="p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <h3 class="font-medium">Colar JSON manualmente (opcional)</h3>
      <p class="text-sm text-slate-500">Cole um JSON aqui para testar, caso não tenha um QRCode agora.</p>
      <textarea id="manualJson" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 p-3 font-mono text-sm" placeholder='{"os":"12345678","peca":"TESTE","caracteristica":"10X20X30","descricao":"TESTE DESCRICAO","gerado_em":"2025-09-18T12:28:00.000Z","tempo_realizacao":"2h30min","responsavel":"Lucas"}'></textarea>
      <div class="mt-2 flex gap-2">
        <button id="btnParseManual" class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">Ler JSON</button>
        <button id="btnExemplo" class="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">Usar exemplo</button>
      </div>
    </section>

    <footer class="py-6 text-center text-xs text-slate-500">
      Feito para celular • funciona no desktop também. Nenhum dado é enviado a servidores: tudo roda no seu navegador.
    </footer>
  </main>

  <script>
    // Estado global simples
    let html5Qr;               // Instância do Html5Qrcode
    let currentCameraId = null;
    let lastDecoded = null;

    const $ = (q) => document.querySelector(q);
    const cameraSelect = $('#cameraSelect');
    const btnStart = $('#btnStart');
    const btnStop = $('#btnStop');
    const btnFlip = $('#btnFlip');
    const readerEl = $('#reader');
    const resultSection = $('#resultSection');
    const cardsEl = $('#cards');
    const rawEl = $('#raw');

    const btnRescan = $('#btnRescan');
    const btnCopy = $('#btnCopy');
    const btnDownload = $('#btnDownload');

    const manualJson = $('#manualJson');
    const btnParseManual = $('#btnParseManual');
    const btnExemplo = $('#btnExemplo');
    const themeToggle = $('#themeToggle');

    // Tema claro/escuro
    const setTheme = (dark) => {
      document.documentElement.classList.toggle('dark', dark);
      document.body.className = document.body.className.replace('from-slate-50 to-slate-100', 'from-slate-900 to-slate-800');
      if (!dark) {
        document.body.className = document.body.className.replace('from-slate-900 to-slate-800', 'from-slate-50 to-slate-100');
      }
    };
    themeToggle.addEventListener('click', () => {
      const dark = !document.documentElement.classList.contains('dark');
      setTheme(dark);
    });

    // Preenche o select de câmeras
    async function listarCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = '';
        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.label || `Câmera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if (devices.length) {
          currentCameraId = devices.find(x => /back|traseira|rear/i.test(x.label))?.id || devices[0].id;
          cameraSelect.value = currentCameraId;
        }
      } catch (e) {
        console.warn('Não foi possível listar câmeras ainda. O navegador pode exigir permissão antes.');
      }
    }

    // Iniciar leitura
    async function iniciarLeitura() {
      try {
        if (!html5Qr) html5Qr = new Html5Qrcode(readerEl.id);
        const camId = cameraSelect.value || { facingMode: 'environment' };

        btnStart.disabled = true;
        btnStop.disabled = false;
        btnFlip.disabled = false;

        await html5Qr.start(
          camId,
          { fps: 10, qrbox: calcularQrbox() },
          onScanSuccess,
          onScanFailure
        );
      } catch (err) {
        alert('Erro ao iniciar câmera: ' + (err?.message || err));
        btnStart.disabled = false;
        btnStop.disabled = true;
      }
    }

    function calcularQrbox() {
      const vw = Math.min(window.innerWidth, 600);
      const size = Math.round(vw * 0.7);
      return { width: size, height: size };
    }

    // Parar leitura
    async function pararLeitura() {
      if (html5Qr) {
        await html5Qr.stop().catch(() => {});
        await html5Qr.clear().catch(() => {});
      }
      btnStart.disabled = false;
      btnStop.disabled = true;
    }

    // Alternar câmera rapidamente
    function alternarCamera() {
      const options = Array.from(cameraSelect.options);
      if (!options.length) return;
      const idx = options.findIndex(o => o.value === cameraSelect.value);
      const next = options[(idx + 1) % options.length];
      cameraSelect.value = next.value;
      pararLeitura().then(iniciarLeitura);
    }

    // Handlers de leitura
    function onScanSuccess(decodedText) {
      if (!decodedText || decodedText === lastDecoded) return;
      lastDecoded = decodedText;
      processarJson(decodedText);
      // Para evitar leituras repetidas, paramos a câmera
      pararLeitura();
    }

    function onScanFailure(/* error */) {
      // silencioso – acontece quando não há QR no quadro
    }

    // Processa o JSON e mostra na tela
    function processarJson(text) {
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        // Pode ser que o QR contenha URL com query ?data=...
        try {
          const url = new URL(text);
          const d = url.searchParams.get('data') || url.searchParams.get('json');
          if (d) data = JSON.parse(d);
        } catch {}
      }

      if (!data || typeof data !== 'object') {
        alert('O QRCode não contém um JSON válido.');
        return;
      }

      // Renderiza cartões
      const campos = [
        ['OS', data.os],
        ['Peça', data.peca],
        ['Característica', data.caracteristica],
        ['Descrição', data.descricao],
        ['Gerado em', formatarData(data.gerado_em)],
        ['Tempo de realização', data.tempo_realizacao],
        ['Responsável', data.responsavel]
      ];

      cardsEl.innerHTML = '';
      campos.forEach(([label, value]) => {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border border-slate-200 bg-slate-50';
        card.innerHTML = `
          <div class="text-xs uppercase tracking-wide text-slate-500">${esc(label)}</div>
          <div class="mt-1 text-lg font-medium text-slate-900">${esc(value ?? '—')}</div>
        `;
        cardsEl.appendChild(card);
      });

      rawEl.textContent = JSON.stringify(data, null, 2);
      resultSection.classList.remove('hidden');
      document.getElementById('hint').textContent = 'Leitura concluída. Você pode ler novamente se desejar.';
    }

    function esc(v) {
      return String(v ?? '').replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
    }

    function formatarData(v) {
      try {
        const d = new Date(v);
        if (isNaN(d)) return String(v ?? '');
        return new Intl.DateTimeFormat('pt-BR', {
          dateStyle: 'short', timeStyle: 'short'
        }).format(d);
      } catch {
        return String(v ?? '');
      }
    }

    // Ações dos botões
    btnStart.addEventListener('click', iniciarLeitura);
    btnStop.addEventListener('click', pararLeitura);
    btnFlip.addEventListener('click', alternarCamera);

    btnRescan.addEventListener('click', () => {
      resultSection.classList.add('hidden');
      lastDecoded = null;
      iniciarLeitura();
    });

    btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(rawEl.textContent);
        btnCopy.textContent = 'Copiado!';
        setTimeout(() => (btnCopy.textContent = 'Copiar JSON'), 1200);
      } catch {
        alert('Não foi possível copiar. Selecione o texto e copie manualmente.');
      }
    });

    btnDownload.addEventListener('click', () => {
      const blob = new Blob([rawEl.textContent], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      try {
        const { os = 'dados' } = JSON.parse(rawEl.textContent || '{}');
        a.download = `qr-${os}.json`;
      } catch { a.download = 'qr.json'; }
      a.click();
      URL.revokeObjectURL(a.href);
    });

    btnParseManual.addEventListener('click', () => processarJson(manualJson.value));
    btnExemplo.addEventListener('click', () => {
      const exemplo = {
        os: '12345678',
        peca: 'TESTE',
        caracteristica: '10X20X30',
        descricao: 'TESTE DESCRICAO',
        gerado_em: '2025-09-18T12:28:00.000Z',
        tempo_realizacao: '2h30min',
        responsavel: 'Lucas'
      };
      manualJson.value = JSON.stringify(exemplo, null, 2);
      processarJson(JSON.stringify(exemplo));
    });

    // Inicialização
    window.addEventListener('load', listarCameras);
    window.addEventListener('resize', () => {
      // Ajusta a caixa de leitura se estiver ativo
      if (html5Qr && !btnStart.disabled) {
        pararLeitura().then(iniciarLeitura);
      }
    });
  </script>
</body>
</html>
