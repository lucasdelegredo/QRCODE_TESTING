<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>SCANNER APP</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #f7f8fb;
        color: #0f172a;
      }
      .wrap {
        max-width: 820px;
        margin: 0 auto;
        padding: 16px;
        text-align: center;
      }
      h1 {
        font-size: 18px;
        margin: 12px 0 16px;
      }

      /* Área do leitor */
      #reader {
        width: 100%;
        max-width: 540px;
        margin: 0 auto;
      }

      /* Resultado em cards */
      #resultView {
        display: none;
        text-align: left;
        margin-top: 16px;
      }
      .cards {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      @media (min-width: 620px) {
        .cards {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (min-width: 960px) {
        .cards {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      .card {
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 14px;
        padding: 14px;
      }
      .label {
        color: #64748b;
        font-size: 11px;
        letter-spacing: 0.4px;
        text-transform: uppercase;
      }
      .value {
        margin-top: 4px;
        font-size: 18px;
        font-weight: 700;
        word-break: break-word;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin: 16px 0 10px;
      }
      .btn {
        appearance: none;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        color: #0f172a;
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn.primary {
        background: linear-gradient(135deg, #0ea5e9, #0369a1);
        border-color: transparent;
        color: #fff;
      }
      .note {
        font-size: 12px;
        color: #64748b;
        margin-top: 10px;
        text-align: center;
      }
      pre {
        background: #0b1220;
        color: #e5e7eb;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        overflow: auto;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- sua biblioteca -->
    <script src="./qrScript.js"></script>

    <div class="wrap">
      <h1>SCANNER APP</h1>

      <!-- leitor -->
      <div id="reader" style="width: 500px;"></div>
      <p class="note">
        Aponte a câmera para o QRCode. Após a leitura, os campos serão preenchidos.
      </p>

      <!-- resultado (página de campos) -->
      <div id="resultView">
        <div class="toolbar">
          <h2 style="margin:0">Informações lidas</h2>
          <div>
            <button id="btnRescan" class="btn">Ler novamente</button>
            <button id="btnCopy" class="btn">Copiar JSON</button>
            <button id="btnDownload" class="btn">Baixar JSON</button>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <div class="label">OS</div>
            <div id="f-os" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Peça</div>
            <div id="f-peca" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Característica</div>
            <div id="f-caracteristica" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Descrição</div>
            <div id="f-descricao" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Gerado em</div>
            <div id="f-gerado" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Tempo de realização</div>
            <div id="f-tempo" class="value">—</div>
          </div>
          <div class="card">
            <div class="label">Responsável</div>
            <div id="f-resp" class="value">—</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <details open>
            <summary style="cursor:pointer; font-weight:700">JSON bruto</summary>
            <pre id="raw"></pre>
          </details>
        </div>
      </div>
    </div>

    <script>
      // ===== Scanner (mantendo sua base) =====
      const html5Qrcode = new Html5Qrcode("reader");

      // Exibição
      const resultView = document.getElementById("resultView");
      const rawEl = document.getElementById("raw");
      const btnRescan = document.getElementById("btnRescan");
      const btnCopy = document.getElementById("btnCopy");
      const btnDownload = document.getElementById("btnDownload");

      // Campos
      const fOS = document.getElementById("f-os");
      const fPeca = document.getElementById("f-peca");
      const fCar = document.getElementById("f-caracteristica");
      const fDesc = document.getElementById("f-descricao");
      const fGer = document.getElementById("f-gerado");
      const fTmp = document.getElementById("f-tempo");
      const fResp = document.getElementById("f-resp");

      // Helpers
      function esc(v) {
        return String(v ?? "").replace(/[&<>]/g, (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[s]));
      }
      function formatDate(v) {
        try {
          const d = new Date(v);
          if (isNaN(d)) return String(v ?? "");
          return new Intl.DateTimeFormat("pt-BR", { dateStyle: "short", timeStyle: "short" }).format(d);
        } catch {
          return String(v ?? "");
        }
      }
      // Parser tolerante: JSON, ?data=..., ou objeto com aspas simples
      function parseJsonTolerante(text) {
        try { return JSON.parse(text); } catch {}
        try {
          const u = new URL(text);
          const raw = u.searchParams.get("data") || u.searchParams.get("json");
          if (raw) return JSON.parse(raw);
        } catch {}
        if (/^\s*\{[\s\S]*\}\s*$/.test(text) && text.includes("'")) {
          let s = text.trim();
          s = s.replace(/([,{]\s*)([a-zA-Z0-9_]+)\s*:/g, '$1"$2":');
          s = s.replace(/'([^']*)'/g, (_m, p1) => `"${p1.replace(/"/g, '\\"')}"`);
          try { return JSON.parse(s); } catch {}
        }
        return null;
      }

      // Renderiza os cards e o JSON
      function renderData(data) {
        fOS.textContent = esc(data.os ?? "—");
        fPeca.textContent = esc(data.peca ?? "—");
        fCar.textContent = esc(data.caracteristica ?? "—");
        fDesc.textContent = esc(data.descricao ?? "—");
        fGer.textContent = esc(formatDate(data.gerado_em));
        fTmp.textContent = esc(data.tempo_realizacao ?? "—");
        fResp.textContent = esc(data.responsavel ?? "—");

        rawEl.textContent = JSON.stringify(data, null, 2);
      }

      // Callback de sucesso: mostra a “página” com os campos
      const qrCodeSuccessCallback = async (decodedText /*, decodedResult */) => {
        if (!decodedText) return;

        // parar leitura
        try { await html5Qrcode.stop(); await html5Qrcode.clear(); } catch {}

        // tentar interpretar
        const data = parseJsonTolerante(decodedText);
        if (!data || typeof data !== "object") {
          // se não for JSON, mostra só o bruto
          resultView.style.display = "block";
          renderData({ os: "", peca: "", caracteristica: "", descricao: "", gerado_em: "", tempo_realizacao: "", responsavel: "" });
          rawEl.textContent = decodedText;
          return;
        }

        // preencher campos
        renderData(data);
        resultView.style.display = "block";
      };

      // Config do leitor (igual ao seu, com qrbox 250x250)
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      // Inicia automaticamente como no seu exemplo
      html5Qrcode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);

      // Ações
      btnRescan.addEventListener("click", async () => {
        resultView.style.display = "none";
        try {
          await html5Qrcode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
        } catch (e) {
          alert("Erro ao reiniciar câmera: " + (e?.message || e));
        }
      });

      btnCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(rawEl.textContent || "");
          btnCopy.textContent = "Copiado!";
          setTimeout(() => (btnCopy.textContent = "Copiar JSON"), 1000);
        } catch {}
      });

      btnDownload.addEventListener("click", () => {
        const blob = new Blob([rawEl.textContent || ""], { type: "application/json" });
        const a = document.createElement("a");
        let nome = "qr-dados.json";
        try {
          const os = JSON.parse(rawEl.textContent || "{}").os;
          if (os) nome = `qr-${os}.json`;
        } catch {}
        a.href = URL.createObjectURL(blob);
        a.download = nome;
        a.click();
        URL.revokeObjectURL(a.href);
      });
    </script>
  </body>
</html>
